### Протокол пакетной передачи текстовых сообщений через голосовую связь (VoiceText Protocol, VTP)

#### **Цель**
Передача коротких текстовых сообщений (до 255 символов) через аналоговые/цифровые голосовые каналы телефонной связи с минимальными требованиями к оборудованию и устойчивостью к шуму.

---

### **Ключевые характеристики**
- **Скорость передачи**: 100 бод (10 мс на бит).
- **Частоты**: 
  - `0` → **1000 Гц** (низкочастотный тон),
  - `1` → **2000 Гц** (высокочастотный тон).
- **Кодировка данных**: ASCII (латиница) или UTF-8 (для Unicode), байты передаются **LSB first** (младший бит первым).
- **Макс. длина сообщения**: 255 байт (ограничено полем длины в заголовке).
- **Устойчивость к шуму**: CRC-8 для проверки целостности, преамбула для синхронизации.

---

### **Структура пакета**
Каждый пакет состоит из 5 частей (см. рисунок ниже):

```
[Преамбула] → [Заголовок] → [Данные] → [CRC-8] → [Постамбула]
```

#### 1. **Преамбула (160 мс)**
- **Цель**: Синхронизация приемника с передатчиком.
- **Формат**: 
  - 16 бит чередующихся `1` и `0` (`10101010 10101010`).
  - Каждый бит длится **10 мс** (итого 160 мс).
- **Пример**: 
  - `1` → 2000 Гц (10 мс), 
  - `0` → 1000 Гц (10 мс), 
  - повторить 16 раз.

#### 2. **Заголовок (160 мс)**
- **Длина**: 2 байта (16 бит).
  - **Байт 1: Длина данных** (0–255) — количество байт в поле *Данные*.
  - **Байт 2: Тип пакета**:
    - `0x01` — текстовое сообщение,
    - `0x02` — подтверждение получения (ACK),
    - `0xFF` — ошибка/повторная передача.

#### 3. **Данные (переменная длина)**
- **Формат**: 
  - Текст в ASCII/UTF-8 (каждый символ = 1–4 байта).
  - Байты передаются **LSB first** (пример: байт `0x41` (символ `A`) кодируется как `10000010`).
- **Пример для "OK"**:
  - `O` = `0x4F` → биты: `11110100` (LSB first),
  - `K` = `0x4B` → биты: `11010010`.

#### 4. **Контрольная сумма (80 мс)**
- **Алгоритм**: CRC-8 (полином `0x07`, начальное значение `0x00`).
- **Проверка**: CRC вычисляется от **Заголовка + Данных**.
- **Пример**: Для заголовка `[0x02, 0x01]` и данных `[0x4F, 0x4B]` CRC = `0x3A`.

#### 5. **Постамбула (20 мс)**
- **Цель**: Обозначение конца передачи.
- **Формат**: 
  - Тон **1500 Гц** (20 мс).

---

### **Процесс передачи**
1. **Кодирование сообщения**:
   - Текст преобразуется в байты (ASCII/UTF-8).
   - Вычисляется длина данных (макс. 255).
2. **Формирование пакета**:
   - Добавляется заголовок (длина + тип).
   - Вычисляется CRC-8.
3. **Генерация аудио**:
   - Преамбула → Заголовок → Данные → CRC → Постамбула.
   - Каждый бит кодируется тоном (10 мс на бит).
4. **Передача через микрофон**:
   - Аудио проигрывается в телефонную трубку.

---

### **Процесс приема**
1. **Обнаружение преамбулы**:
   - Анализ аудио на наличие чередующихся тонов 1000/2000 Гц (160 мс).
   - Используется Goertzel-алгоритм или FFT для распознавания частот.
2. **Чтение пакета**:
   - После преамбулы данные считываются с интервалом **10 мс/бит**.
   - Байты восстанавливаются в порядке **LSB first**.
3. **Проверка CRC**:
   - Если CRC верна → сообщение обрабатывается.
   - Если CRC неверна → пакет игнорируется (ожидание новой преамбулы).
4. **Подтверждение получения (опционально)**:
   - Получатель отправляет ACK-пакет (`тип = 0x02`).

---

### **Пример передачи**
**Сообщение**: `"Hi"` (ASCII: `H=0x48`, `i=0x69`).

1. **Заголовок**:
   - Длина = `2` → байт `0x02` (биты: `01000000` в LSB first),
   - Тип = `0x01` → байт `0x01` (биты: `10000000`).
2. **Данные**:
   - `H` = `0x48` → биты: `00010010`,
   - `i` = `0x69` → биты: `10010110`.
3. **CRC-8** для `[0x02, 0x01, 0x48, 0x69]` = `0x1E`.
4. **Аудио-последовательность**:
   - Преамбула (160 мс) → Заголовок (160 мс) → Данные (160 мс) → CRC (80 мс) → Постамбула (20 мс).

---

### **Преимущества протокола**
1. **Устойчивость к шуму**:
   - CRC-8 отсеивает поврежденные пакеты.
   - Низкая скорость (100 бод) снижает ошибки из-за искажений канала.
2. **Простота реализации**:
   - Минимальные вычислительные ресурсы (Goertzel вместо FFT).
   - Подходит для embedded-устройств (Arduino, Raspberry Pi).
3. **Совместимость**:
   - Работает на любых голосовых каналах (GSM, VoIP, PSTN).
   - Частоты 1000/2000 Гц укладываются в полосу 300–3400 Гц телефонных линий.

---

### **Ограничения и рекомендации**
- **Длина сообщения**: До 255 символов (для больших данных — разбивка на пакеты с нумерацией).
- **Скорость**: 100 бод (≈ 12 символов/сек). Для увеличения скорости можно сократить длительность бита до 5 мс (200 бод), но это повысит ошибки.
- **Шум**: В noisy-каналах добавить повторную передачу (макс. 3 попытки).
- **Кодеки VoIP**: Избегать частот близких к границам полосы (1000/2000 Гц безопасны для G.711, Opus).

---

### **Схема реализации**
```plaintext
Отправитель: 
Текст → ASCII → Пакет (Заголовок + Данные + CRC) → Генерация тонов → Микрофон

Получатель: 
Микрофон → Анализ тонов → Сборка пакета → Проверка CRC → Текст
```

Этот протокол позволяет передавать текст даже через низкокачественные каналы (например, радиосвязь или старые телефоны) без специального оборудования. Для тестирования можно использовать Python-библиотеки `pyaudio` и `numpy` для генерации/анализа аудио.